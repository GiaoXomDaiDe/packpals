<!DOCTYPE html>
<html>
<head>
    <title>Test Backend Payment Response</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
            backdrop-filter: blur(10px);
        }
        .btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: white;
            color: #667eea;
        }
        .debug {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }
        input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Test Backend Payment Response</h1>
        
        <div>
            <h3>Simulate Backend Response</h3>
            <input type="text" id="backendUrl" placeholder="Backend URL" 
                   value="https://3fea27d64506.ngrok-free.app/payment/success">
            <input type="text" id="orderId" placeholder="Order ID" value="test-123">
            <input type="text" id="orderCode" placeholder="Order Code" value="456789">
            
            <button class="btn" onclick="testBackendResponse()">ğŸ”— Test Backend Response</button>
            <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
        </div>
        
        <div>
            <h3>Direct Deeplink Tests</h3>
            <button class="btn" onclick="testDirectDeeplink()">ğŸ“± Test Direct Deeplink</button>
            <button class="btn" onclick="testWithIntent()">ğŸ¤– Test Android Intent</button>
            <button class="btn" onclick="testMultipleMethods()">ğŸš€ Test All Methods</button>
        </div>
        
        <div class="debug" id="debug">ğŸ” Debug Log:
Ready to test...
        </div>
        
        <div style="margin-top: 20px; font-size: 12px; opacity: 0.8;">
            <strong>ğŸ’¡ Debug Steps:</strong><br>
            1. Test backend response to see actual HTML<br>
            2. Check if deeplinks are properly formed<br>
            3. Test direct deeplink triggering<br>
            4. Check browser console for errors<br>
            5. Verify app installation and scheme handling
        </div>
    </div>

    <script>
        let logCounter = 0;

        function log(message, type = 'info') {
            const debugDiv = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logCounter++;
            debugDiv.innerHTML += `\n[${logCounter}] [${timestamp}] <span class="${className}">${message}</span>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug').innerHTML = 'ğŸ” Debug Log:\nLog cleared...';
            logCounter = 0;
        }

        function getFormValues() {
            return {
                backendUrl: document.getElementById('backendUrl').value,
                orderId: document.getElementById('orderId').value,
                orderCode: document.getElementById('orderCode').value
            };
        }

        async function testBackendResponse() {
            const { backendUrl, orderId, orderCode } = getFormValues();
            const testUrl = `${backendUrl}?orderId=${orderId}&orderCode=${orderCode}&status=success`;
            
            log(`ğŸŒ Testing backend response: ${testUrl}`, 'info');
            
            try {
                // Test if we can fetch the backend response
                const response = await fetch(testUrl, { 
                    method: 'GET',
                    mode: 'no-cors' // Try to avoid CORS issues for testing
                });
                
                log(`âœ… Backend responded with status: ${response.status}`, 'success');
                
                // Try to open the URL directly
                window.open(testUrl, '_blank');
                log(`ğŸ”— Opened backend URL in new tab`, 'info');
                
            } catch (error) {
                log(`âŒ Backend test failed: ${error.message}`, 'error');
                
                // Fallback: try to open directly anyway
                window.open(testUrl, '_blank');
                log(`ğŸ”— Opened URL directly despite error`, 'warning');
            }
        }

        function testDirectDeeplink() {
            const { orderId, orderCode } = getFormValues();
            const deepLink = `packpals://payment/success?orderId=${orderId}&status=success&orderCode=${orderCode}`;
            
            log(`ğŸ“± Testing direct deeplink: ${deepLink}`, 'info');
            
            // Method 1: Direct location
            try {
                window.location.href = deepLink;
                log(`âœ… Tried window.location.href`, 'success');
            } catch (e) {
                log(`âŒ window.location.href failed: ${e.message}`, 'error');
            }
            
            // Method 2: Link click
            setTimeout(() => {
                try {
                    const link = document.createElement('a');
                    link.href = deepLink;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    log(`âœ… Tried programmatic link click`, 'success');
                } catch (e) {
                    log(`âŒ Link click failed: ${e.message}`, 'error');
                }
            }, 500);
        }

        function testWithIntent() {
            const { orderId, orderCode } = getFormValues();
            
            log(`ğŸ¤– Testing Android intent URL`, 'info');
            
            // Android intent URL format
            const intentUrl = `intent://payment/success?orderId=${encodeURIComponent(orderId)}&status=success&orderCode=${encodeURIComponent(orderCode)}#Intent;scheme=packpals;package=com.anonymous.PackPals;end`;
            
            try {
                window.location.href = intentUrl;
                log(`âœ… Tried Android intent: ${intentUrl}`, 'success');
            } catch (e) {
                log(`âŒ Android intent failed: ${e.message}`, 'error');
            }
        }

        function testMultipleMethods() {
            const { orderId, orderCode } = getFormValues();
            const deepLink = `packpals://payment/success?orderId=${orderId}&status=success&orderCode=${orderCode}`;
            
            log(`ğŸš€ Testing multiple deeplink methods`, 'info');
            
            // Method 1: window.location
            setTimeout(() => {
                try {
                    window.location.href = deepLink;
                    log(`[1] âœ… window.location.href`, 'success');
                } catch (e) {
                    log(`[1] âŒ window.location.href: ${e.message}`, 'error');
                }
            }, 100);
            
            // Method 2: iframe
            setTimeout(() => {
                try {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = deepLink;
                    document.body.appendChild(iframe);
                    log(`[2] âœ… iframe method`, 'success');
                    
                    setTimeout(() => {
                        if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                        }
                    }, 2000);
                } catch (e) {
                    log(`[2] âŒ iframe: ${e.message}`, 'error');
                }
            }, 600);
            
            // Method 3: programmatic click
            setTimeout(() => {
                try {
                    const link = document.createElement('a');
                    link.href = deepLink;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    log(`[3] âœ… programmatic click`, 'success');
                } catch (e) {
                    log(`[3] âŒ programmatic click: ${e.message}`, 'error');
                }
            }, 1200);
            
            // Method 4: Android intent
            setTimeout(() => {
                try {
                    const intentUrl = `intent://payment/success?orderId=${encodeURIComponent(orderId)}&status=success&orderCode=${encodeURIComponent(orderCode)}#Intent;scheme=packpals;package=com.anonymous.PackPals;end`;
                    window.location.href = intentUrl;
                    log(`[4] âœ… Android intent`, 'success');
                } catch (e) {
                    log(`[4] âŒ Android intent: ${e.message}`, 'error');
                }
            }, 1800);
        }

        // Detect if app opened
        let startTime = Date.now();
        
        window.addEventListener('blur', function() {
            log(`ğŸ‘ï¸ Page lost focus - app might have opened!`, 'warning');
        });

        window.addEventListener('focus', function() {
            const timeAway = Date.now() - startTime;
            if (timeAway > 2000) {
                log(`ğŸ‘ï¸ Page regained focus after ${timeAway}ms - returning from app?`, 'warning');
            }
            startTime = Date.now();
        });

        window.addEventListener('beforeunload', function() {
            log(`ğŸšª Page unloading - app might have opened!`, 'success');
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log(`ğŸš€ Test page loaded`, 'success');
            log(`ğŸ“± User Agent: ${navigator.userAgent}`, 'info');
            log(`ğŸŒ Platform: ${navigator.platform}`, 'info');
            log(`ğŸ”— Location: ${window.location.href}`, 'info');
            
            // Check if we're on mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            log(`ğŸ“± Mobile detected: ${isMobile}`, isMobile ? 'success' : 'warning');
        });
    </script>
</body>
</html>